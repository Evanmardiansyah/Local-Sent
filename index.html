<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvanShare Secure</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --primary: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --text: #f1f5f9;
            --muted: #94a3b8;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: var(--card);
            width: 90%;
            max-width: 450px;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            text-align: center;
        }

        h2 { margin: 0 0 5px 0; color: var(--primary); }
        .subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 20px; }

        /* ID & PIN BOX */
        .info-box {
            background: #0f172a;
            border: 1px border #334155;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: left;
        }
        .info-label { font-size: 0.8rem; color: var(--muted); display: block; margin-bottom: 5px;}
        .info-value { font-size: 1.2rem; font-weight: bold; color: var(--success); letter-spacing: 1px; }
        .pin-display { float: right; color: var(--primary); font-family: monospace; cursor: pointer;}

        /* Inputs */
        .input-group { margin-bottom: 15px; text-align: left; }
        input {
            width: 100%;
            padding: 12px;
            background: #334155;
            border: 1px solid #475569;
            color: white;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1rem;
            margin-top: 5px;
        }
        input:focus { outline: 2px solid var(--primary); }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            color: white;
        }
        .btn-primary { background: var(--primary); }
        .btn-primary:hover { background: #2563eb; }
        .btn-danger { background: var(--danger); margin-top: 10px; }

        /* Log & Status */
        #status { font-weight: bold; margin: 15px 0; font-size: 0.9rem; }
        .log-area {
            background: #000;
            height: 120px;
            overflow-y: auto;
            border-radius: 8px;
            padding: 10px;
            text-align: left;
            font-family: monospace;
            font-size: 0.8rem;
            margin-top: 15px;
            border: 1px solid #334155;
        }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2><i class="fas fa-network-wired"></i> EvanShare Secure</h2>
    <p class="subtitle">Transfer P2P dengan PIN Keamanan</p>

    <div id="status" style="color: var(--muted);">Menyiapkan ID...</div>

    <div id="page-home">
        <div class="info-box">
            <span class="info-label">ID Perangkat Ini:</span>
            <div class="info-value" id="my-id">...</div>
            <hr style="border-color: #334155; opacity: 0.3; margin: 10px 0;">
            <span class="info-label">PIN Keamanan Saya:</span>
            <input type="number" id="my-pin" value="1234" style="width: 80px; padding: 5px; text-align: center;">
            <small style="color: var(--muted); font-size: 0.7rem;">(Teman harus isi PIN ini untuk konek)</small>
        </div>

        <div class="input-group">
            <label class="info-label">ID Teman (Tujuan)</label>
            <input type="text" id="target-id" placeholder="Contoh: PC-Tiger-88">
        </div>
        <div class="input-group">
            <label class="info-label">PIN Teman</label>
            <input type="number" id="target-pin" placeholder="Masukkan PIN teman (Default: 1234)">
        </div>
        
        <button class="btn btn-primary" onclick="initiateConnection()">
            <i class="fas fa-lock"></i> Sambungkan Aman
        </button>
    </div>

    <div id="page-transfer" class="hidden">
        <div style="background: rgba(16, 185, 129, 0.1); padding: 15px; border-radius: 10px; border: 1px solid var(--success);">
            <i class="fas fa-shield-alt" style="color: var(--success);"></i> Koneksi Terverifikasi!
        </div>
        
        <br>
        <input type="file" id="file-input" class="hidden" onchange="handleFileSelect()">
        <button class="btn btn-primary" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-file-export"></i> Pilih File
        </button>
        <div id="file-name-display" style="margin-top:10px; color:#ccc; font-size:0.9rem;"></div>

        <button class="btn btn-danger" onclick="location.reload()">Putuskan</button>
    </div>

    <div class="log-area" id="log-box">
        <div>> System Ready.</div>
    </div>
</div>

<script>
    // --- 1. CONFIG & RANDOM NAME GENERATOR ---
    // Nama random biar keren: PC-Lion-99
    const devices = ["PC", "Laptop", "HP", "Tab"];
    const animals = ["Tiger", "Lion", "Eagle", "Shark", "Wolf", "Bear"];
    
    function generateId() {
        const dev = devices[Math.floor(Math.random() * devices.length)];
        const ani = animals[Math.floor(Math.random() * animals.length)];
        const num = Math.floor(10 + Math.random() * 90); // 10-99
        return `${dev}-${ani}-${num}`;
    }

    const myId = generateId();
    const peerConfig = {
        debug: 1,
        config: { 'iceServers': [{ url: 'stun:stun.l.google.com:19302' }] }
    };

    let peer = new Peer(myId, peerConfig);
    let conn = null;
    let isAuthenticated = false;

    // --- 2. PEER EVENTS ---
    
    peer.on('open', (id) => {
        document.getElementById('my-id').innerText = id;
        setStatus("Online. Menunggu koneksi...", "#10b981");
    });

    peer.on('error', (err) => {
        log("Error: " + err.type);
        if(err.type === 'unavailable-id') alert("ID tabrakan, refresh halaman!");
        else setStatus("Koneksi Error. Cek Jaringan.", "#ef4444");
    });

    // --- 3. LOGIKA PENERIMA (SERVER SIDE LOGIC) ---
    // Saat ada orang asing mau masuk
    peer.on('connection', (c) => {
        conn = c;
        
        // Jangan langsung terima! Tunggu dia kirim PIN dulu.
        log(`Ada permintaan koneksi dari ${conn.peer}...`);
        setStatus("Memverifikasi PIN pengirim...", "#facc15");

        conn.on('data', (data) => {
            // A. Fase Handshake (Cek PIN)
            if (data.type === 'auth-request') {
                const myPin = document.getElementById('my-pin').value;
                if (data.pin === myPin) {
                    log("PIN Benar! Koneksi diterima.");
                    conn.send({ type: 'auth-response', status: 'success' });
                    isAuthenticated = true;
                    showTransferPage();
                } else {
                    log("PIN SALAH! Menolak koneksi.");
                    conn.send({ type: 'auth-response', status: 'fail' });
                    setTimeout(() => conn.close(), 500); // Tendang user
                }
            }
            
            // B. Fase Terima File (Hanya jika sudah Authenticated)
            else if (data.type === 'file' && isAuthenticated) {
                log(`Menerima file: ${data.filename}`);
                const blob = new Blob([data.file], { type: data.filetype });
                const url = URL.createObjectURL(blob);
                logHTML(`<a href="${url}" download="${data.filename}" style="color:yellow; text-decoration:none;">[DOWNLOAD ${data.filename}]</a>`);
            }
        });

        conn.on('close', () => {
            alert("Koneksi terputus.");
            location.reload();
        });
    });

    // --- 4. LOGIKA PENGIRIM (CLIENT SIDE LOGIC) ---
    function initiateConnection() {
        const targetId = document.getElementById('target-id').value.trim();
        const targetPin = document.getElementById('target-pin').value.trim();

        if(!targetId || !targetPin) return alert("ID dan PIN tidak boleh kosong!");

        setStatus(`Menghubungi ${targetId}...`, "#facc15");
        conn = peer.connect(targetId);

        conn.on('open', () => {
            log("Terhubung ke server peer. Mengirim PIN...");
            // Kirim PIN untuk diverifikasi
            conn.send({ type: 'auth-request', pin: targetPin });
        });

        conn.on('data', (data) => {
            if (data.type === 'auth-response') {
                if (data.status === 'success') {
                    log("PIN Diterima! Koneksi Aman.");
                    isAuthenticated = true;
                    showTransferPage();
                } else {
                    alert("PIN SALAH! Koneksi ditolak oleh penerima.");
                    conn.close();
                }
            }
        });

        conn.on('error', (err) => log("Koneksi error: " + err));
    }

    // --- 5. TRANSFER FILE ---
    function handleFileSelect() {
        const file = document.getElementById('file-input').files[0];
        if (file) {
            document.getElementById('file-name-display').innerText = "Siap kirim: " + file.name;
            sendFile(file);
        }
    }

    function sendFile(file) {
        if(!conn || !isAuthenticated) return alert("Belum konek aman!");
        
        log(`Mengirim ${file.name}...`);
        conn.send({
            type: 'file',
            file: file,
            filename: file.name,
            filetype: file.type
        });
        log("File terkirim!");
    }

    // --- UTILS ---
    function showTransferPage() {
        document.getElementById('page-home').classList.add('hidden');
        document.getElementById('page-transfer').classList.remove('hidden');
        setStatus("Terhubung Aman (Encrypted)", "#10b981");
    }

    function setStatus(msg, color) {
        const el = document.getElementById('status');
        el.innerText = msg;
        el.style.color = color;
    }

    function log(msg) {
        const box = document.getElementById('log-box');
        const d = document.createElement('div');
        d.innerText = "> " + msg;
        box.prepend(d);
    }
    
    function logHTML(html) {
        const box = document.getElementById('log-box');
        const d = document.createElement('div');
        d.innerHTML = "> " + html;
        box.prepend(d);
    }
</script>

</body>
</html>
